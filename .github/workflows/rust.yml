name: Rust CI

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        toolchain: [stable]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev

      - name: Install Rust ${{ matrix.toolchain }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
          components: clippy, rustfmt

      - name: Rustfmt Check
        run: cargo fmt --all -- --check

      - name: Clippy Check
        run: cargo clippy --all-targets --all-features -- -D warnings

  netease-plugin-smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tools/stellatune-ncm-sidecar/package-lock.json

      - name: Build plugin crate
        run: |
          cargo build --manifest-path crates/plugins-native/stellatune-plugin-netease/source/Cargo.toml --target wasm32-wasip2 --release
          cargo build --manifest-path crates/plugins-native/stellatune-plugin-netease/decoder/Cargo.toml --target wasm32-wasip2 --release

      - name: Package plugin artifact
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File crates/plugins-native/stellatune-plugin-netease/scripts/package-windows.ps1

      - name: Verify packaged files
        shell: pwsh
        run: |
          $zip = Get-ChildItem target/plugins -Filter "*.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($null -eq $zip) { throw "packaged zip not found under target/plugins" }
          $extractDir = Join-Path $env:RUNNER_TEMP "netease-plugin-smoke"
          if (Test-Path $extractDir) { Remove-Item -Recurse -Force $extractDir }
          Expand-Archive -Path $zip.FullName -DestinationPath $extractDir -Force
          if (-not (Test-Path (Join-Path $extractDir "wasm/stellatune_plugin_netease_source.wasm"))) {
            throw "missing packaged source wasm"
          }
          if (-not (Test-Path (Join-Path $extractDir "wasm/stellatune_plugin_netease_decoder.wasm"))) {
            throw "missing packaged decoder wasm"
          }
          if (-not (Test-Path (Join-Path $extractDir "bin/stellatune-ncm-sidecar.exe"))) {
            throw "missing packaged sidecar executable"
          }

      - name: Sidecar exe health smoke
        shell: pwsh
        run: |
          $extractDir = Join-Path $env:RUNNER_TEMP "netease-plugin-smoke"
          $exe = Join-Path $extractDir "bin/stellatune-ncm-sidecar.exe"
          if (-not (Test-Path $exe)) {
            throw "sidecar executable not found for smoke test"
          }
          $proc = Start-Process -FilePath $exe -WorkingDirectory (Split-Path -Parent $exe) -PassThru
          try {
            $ready = $false
            for ($i = 0; $i -lt 20; $i++) {
              Start-Sleep -Milliseconds 500
              try {
                $resp = Invoke-RestMethod -Uri "http://127.0.0.1:46321/health" -Method Get -TimeoutSec 3
                if ($resp.ok -eq $true) {
                  $ready = $true
                  break
                }
              } catch {}
            }
            if (-not $ready) {
              throw "sidecar health endpoint did not become ready"
            }
          }
          finally {
            if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }
